
{% extends "harvester/base.html" %}
{% load static  placeholder widget_tweaks %}
{% block title %}
{% if form.instance.pk %}
Leverans till {{form.instance}}
{% else %}
Ny leverans
{% endif %}
{% endblock %}
{% block content %}
{% include "harvester/harvest-item-modal.html" %}
<h1>Leverans</h1>
<form action="" method="POST" class="grid-form" novalidate>
    {% csrf_token %}
<div class="row">
    <div class="col-md-12">
    <div class="row">
        <div class="col-xs-6">{{ form.customer|add_class:'form-control' }}{{ form.customer.errors }}</div>
        <div class="col-xs-6">{{ form.target_date|add_class:'form-control' }}{{ form.target_date.errors }}</div>
    </div>
        </div>
</div>



    {% for hidden in form.hidden_fields %}
    {{ hidden }}
    {% endfor %}

    {{ delivery_item_form.management_form }}
    {{ delivery_item_form.non_form_errors }}

    {% for form2 in delivery_item_form %}
    <div class="form-container">
    <div class="visible-xs" style="height:5em"></div>

    <div class="row">
        <div class="col-md-3">
            <div class="row">
                <div class="col-xs-4">
                    {{form2.crop|add_class:'form-control'}}
                    {{form2.crop.errors}}
                </div>
                <div class="col-xs-4">
                    {{form2.cropform|add_class:'form-control'}} {{form2.cropform.errors}}
                </div>

                <div class="col-xs-4">
                    <div class="input-group">
                    {{form2.order_amount|add_class:'form-control w-50'}}
                        {{form2.order_unit|add_class:'form-control input-group-addon w-50'}}{{form2.order_unit.errors}}
                        </div>
                </div>

            </div>
        </div>
        <div class="col-md-1">
            <div class="row">
                <div class="col-xs-12">
                    {{form2.order_comment|add_class:'form-control'}}{{form2.order_comment.errors}}
                </div>
            </div>
        </div>
        <div class="mobile-hide col-md-2">
            <div class="row">
                <div class="col-xs-8">
                    <div class="input-group">
                    {{form2.price|add_class:'form-control w-50'}}
                    {{form2.price_type|add_class:'form-control input-group-addon w-50'}} {{form2.price_type.errors}} {{form2.price.errors}}
                        </div>
                </div>



                <div class="col-xs-4">
                    <div class="input-group">
                    {{form2.discount|add_class:' form-control '}} {{form2.discount.errors}}
                        <span class="w-50 input-group-addon">%</span>
                        </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="row">
            <div class="col-xs-6">

            <button style="width:100%"
                    type="button"
                    {%if form2.instance.pk%} id="harvest-button-{{form2.instance.pk}}" {%endif%}
                    data-id="{{form2.instance.pk}}"
                    onClick="return false;"
                    class="btn btn-default {% if not form2.instance.pk %} hidden {%endif%}"
                    data-toggle="modal"
                    data-load-url="/harvester/deliveries/harvests/{{form2.instance.pk}}"
                    data-target="#harvest-item-modal"
                    data-query-url="{% url 'deliveries_harvest_for_delivery' %}">
                <span class="harvested">0</span>/<span class="target">0</span> <span class="unit">kg</span>
            </button>

                <script>
                {%if form2.instance.pk%}
                $( document ).ready(function() {
                    reload_harvest_button("harvest-button-{{form2.instance.pk}}");
                    })
                    {%endif%}
                </script>
            </div>
                 <div class="col-xs-3">
                     {{form2.closed}}
                     </div>
                <div class="col-xs-3">
            <button style="width:100%" type="button"  class="del-button btn btn-danger">Ta bort</button>
            </div>
                </div>
        </div>

        <div class="mobile-hide col-md-2">
            <div class="row">


                <div class="col-xs-12">
                    {{form2.delivery_comment|add_class:"form-control"}}
                                        {% if delivery_item_form.can_delete %}
                {{ form2.DELETE }}
                {% endif %}


                </div>

            </div>

        </div>


    </div>



    {% for hidden in form2.hidden_fields %}
    {{ hidden }}
    {% endfor %}
</div>
    {% endfor %}

    <script>


    </script>
    <button type="button" id="add-btn" class="btn btn-default">Lägg till rad</button>
    <input id="save_harvest_item" type="submit" value="Save"/>
    <script>




$( document ).ready(function() {

    num_rows = parseInt(document.getElementById('id_deliveryitem_set-TOTAL_FORMS').value)


    for (i=0;i<num_rows;i++) {
        prefix= "id_deliveryitem_set-"+i+"-";
        ajax_populate_select('{% url 'deliveries_new_cropform_for_crop'  %}', ['crop'],'cropform',prefix);
        ajax_populate_select('{% url 'deliveries_new_order_units_for_cropform'  %}', ['cropform'],'order_unit',prefix,true);
        ajax_populate_select('{% url 'deliveries_new_price_units_for_cropform'  %}', ['cropform'],'price_type',prefix,true);
    }

$('form').on('submit', function() {
    $('[id $=crop]').prop('disabled', false);
    $('[id $=cropform]').prop('disabled', false);
});

function fixRow(row) {
    // Ta bort
    row.find('*').off("change");
    row.find('[id $=crop]').prop('disabled', false);
    row.find('[id $=crop]').prop('disabled', false);
    row.find('[id $=closed]').bootstrapSwitch();
    row.find('[id $=crop]')[0].selectedIndex = 0
    row.find('[id $=cropform]').prop('disabled', false);
    row.find('[id $=discount]').val(0.0);
    id = row.find('[id $=crop]').attr('id');
    i =  /-(\d+)-crop/.exec(id)[1]
    prefix= "id_deliveryitem_set-"+i+"-";

        ajax_populate_select('{% url 'deliveries_new_cropform_for_crop'  %}', ['crop'],'cropform',prefix,true);
        ajax_populate_select('{% url 'deliveries_new_order_units_for_cropform'  %}', ['cropform'],'order_unit',prefix,true);
        ajax_populate_select('{% url 'deliveries_new_price_units_for_cropform'  %}', ['cropform'],'price_type',prefix,true);


}

function pre_remove(row) {

    harvested=$(row).find('.harvested');
    i=parseFloat(harvested.text());
    if (i>0)
        {
                BootstrapDialog.alert('Kan inte ta bort eftersom det redan finns registrerad skörd. Ta bort denna först!');
                return false;
        }

        return confirm("Ta bort?");

}

$('.form-container').formset({
            'add_btn_id':"#add-btn",
            deleteCssClass: 'del-button',
            prefix: '{{ delivery_item_form.prefix }}',
            added:fixRow,
            pre_remove:pre_remove
        });

$.fn.bootstrapSwitch.defaults.size = 'mini';
$.fn.bootstrapSwitch.defaults.onText = "klar";
$.fn.bootstrapSwitch.defaults.offText = "ej klar";
$('[id $=closed]').bootstrapSwitch();

});



    </script>
</form>
{% endblock %}